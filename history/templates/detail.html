<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
    crossorigin="anonymous">
    <!-- Custom styles for this template -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}"></link>

    <title>FAME</title>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
      <nav class="navbar navbar-dark fixed-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="/">FAME</a>
      </nav>
      <div class="container-fluid">
        <div class="row">
        <nav class="col-md-2 d-none d-md-block bg-light sidebar">
          <div class="sidebar-sticky">
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link" href="/">
                  <svg class="bi bi-upload" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M.5 8a.5.5 0 01.5.5V12a1 1 0 001 1h12a1 1 0 001-1V8.5a.5.5 0 011 0V12a2 2 0 01-2 2H2a2 2 0 01-2-2V8.5A.5.5 0 01.5 8zM5 4.854a.5.5 0 00.707 0L8 2.56l2.293 2.293A.5.5 0 1011 4.146L8.354 1.5a.5.5 0 00-.708 0L5 4.146a.5.5 0 000 .708z" clip-rule="evenodd"/>
                    <path fill-rule="evenodd" d="M8 2a.5.5 0 01.5.5v8a.5.5 0 01-1 0v-8A.5.5 0 018 2z" clip-rule="evenodd"/>
                  </svg>
                  Upload
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="/history">
                  <svg class="bi bi-clock-history" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M8.515 1.019A7 7 0 008 1V0a8 8 0 01.589.022l-.074.997zm2.004.45a7.003 7.003 0 00-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 00-.439-.27l.493-.87a8.025 8.025 0 01.979.654l-.615.789a6.996 6.996 0 00-.418-.302zm1.834 1.79a6.99 6.99 0 00-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 00-.214-.468l.893-.45a7.976 7.976 0 01.45 1.088l-.95.313a7.023 7.023 0 00-.179-.483zm.53 2.507a6.991 6.991 0 00-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1 .025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.957 7.957 0 01-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-.964 1.205c.122-.122.239-.248.35-.378l.758.653a8.073 8.073 0 01-.401.432l-.707-.707z" clip-rule="evenodd"/>
                    <path fill-rule="evenodd" d="M8 1a7 7 0 104.95 11.95l.707.707A8.001 8.001 0 118 0v1z" clip-rule="evenodd"/>
                    <path fill-rule="evenodd" d="M7.5 3a.5.5 0 01.5.5v5.21l3.248 1.856a.5.5 0 01-.496.868l-3.5-2A.5.5 0 017 9V3.5a.5.5 0 01.5-.5z" clip-rule="evenodd"/>
                  </svg>
                  History
                </a>
              </li>
            </ul>
          </div>
        </nav>


        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4 wrapper">
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Job Result</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
              <div class="btn-group mr-2">
                <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
                <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
              </div>
            </div>
          </div>
          <canvas id="overview" width="800" height="400"></canvas>
          <canvas id="detail" width="800" height="400"></canvas>
          <canvas id="detail-line" width="800" height="400"></canvas>
          <div class="footer">
            <p>
              Â© Facial Analyzer for Multimedia Entertainment
            </p>
          </div>
        </main>
    </div>
    </div>
    <p id="result" style="display: none;">{{ result.result }}</p>
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script>
        let resultArray = JSON.parse($("#result").text().replace(/'/g, '"')).result;
        resultArray.sort((a, b) => (a.timestamp > b.timestamp) ? 1 : -1);

        /* Overview Chart*/
        let extractExpressionResult = function(expressions, expressionArray) {
          let total = 0;
          let nonnegative = 0;
          Object.keys(expressions).forEach(key => {
            total += expressions[key];
            if (expressionArray.includes(key)) nonnegative += expressions[key];
          });
          return nonnegative / total * 100;
        };
        let overviewLabels = resultArray.map(x => x.timestamp);
        let overviewDataPos = resultArray.map(x => extractExpressionResult(x.expressions, ['HAPP', 'SURPRISE']));
        let overviewDataNeg = resultArray.map(x => -(100 - extractExpressionResult(x.expressions, ['ANGRY', 'DISGUST',
        'FEAR', 'SAD'])));
        let overviewDataNeu = resultArray.map(x => extractExpressionResult(x.expressions, ['NEUTRAL']));

        var overviewCtx = document.getElementById('overview').getContext('2d');
        var overviewChart = new Chart(overviewCtx, {
                type: 'line',
                data: {
                    labels: overviewLabels,
                    datasets: [{
                                  label: '% Positive Expressions',
                                  data: overviewDataPos,
                                  backgroundColor: "rgb(255, 99, 132)",
					                        borderColor: "rgb(255, 99, 132)",
                                  borderWidth: 1,
                                  fill: false
                              },
                              {
                                  label: '% Negative Expressions',
                                  data: overviewDataNeg,
                                  backgroundColor: "rgb(54, 162, 235)",
					                        borderColor: "rgb(54, 162, 235)",
                                  borderWidth: 1,
                                  fill: false
                              },
                              {
                                  label: '% Neutral Expressions',
                                  data: overviewDataNeu,
                                  backgroundColor: "rgb(255, 205, 86)",
					                        borderColor: "rgb(255, 205, 86)",
                                  borderWidth: 1,
                                  fill: false
                              }]
                              },
                              options: {
                                  responsive: true,
                                  title: {
                                    display: true,
                                    text: 'Audience Expression Overview Trend'
                                  },
                                  tooltips: {
                                    mode: 'index',
                                    intersect: false,
                                  },
                                  hover: {
                                    mode: 'nearest',
                                    intersect: true
                                  },
                                  scales: {
                                    xAxes: [{
                                      display: true,
                                      scaleLabel: {
                                        display: true,
                                        labelString: 'Time in Video (second)'
                                      }
                                    }],
                                    yAxes: [{
                                      display: true,
                                      scaleLabel: {
                                        display: true,
                                        labelString: 'Percentage %'
                                      }
                                    }]
                                  }
                                }
                          });

        /* Details Chart*/
        let extracDetailExpression = function(resultArray, expression) {
            let expressionArray = [];
            resultArray.forEach(x => {
              if (Object.keys(x.expressions).includes(expression)) {
                expressionArray.push(x.expressions[expression]);
              } else {
                expressionArray.push(0);
              }
            });
            return expressionArray;
        };

        let detailLabels = resultArray.map(x => x.timestamp);
        let detailCtx = document.getElementById('detail').getContext('2d');
        let detailData = {
            labels: detailLabels,
            datasets: [
            {
              label: 'Angry',
              data: extracDetailExpression(resultArray, 'ANGRY'),
              backgroundColor: "#E5004F",
              borderColor: "#E5004F",
              borderWidth: 1,
            },
            {
              label: 'Disgust',
              data: extracDetailExpression(resultArray, 'DISGUST'),
              backgroundColor: "#C49958",
              borderColor: "#C49958",
              borderWidth: 1,
            },
            {
              label: 'Fear',
              data: extracDetailExpression(resultArray, 'FEAR'),
              backgroundColor: "#4D4398",
              borderColor: "#4D4398",
              borderWidth: 1,
            },
            {
              label: 'Sad',
              data: extracDetailExpression(resultArray, 'SAD'),
              backgroundColor: "#FFF9B1",
              borderColor: "#FFF9B1",
              borderWidth: 1,
            },
            {
              label: 'Neutral',
              data: extracDetailExpression(resultArray, 'NEUTRAL'),
              backgroundColor: "#FEECD2",
              borderColor: "#FEECD2",
              borderWidth: 1,
            },{
              label: 'Happy',
              data: extracDetailExpression(resultArray, 'HAPPY'),
              backgroundColor: "#F39800",
              borderColor: "#F39800",
              borderWidth: 1,
            },
            {
              label: 'Surprise',
              data: extracDetailExpression(resultArray, 'SURPRISE'),
              backgroundColor: "#F5B090",
              borderColor: "#F5B090",
              borderWidth: 1,
            }]
          };

        let detailChart = new Chart(detailCtx, {
              type: 'bar',
              data: detailData,
              options: {
                title: {
                  display: true,
                  text: 'Audience Expression Detailed Timeline'
                },
                tooltips: {
                  mode: 'index',
                  intersect: false
                },
                responsive: true,
                scales: {
                  xAxes: [{
                    stacked: true,
                    scaleLabel: {
                                  display: true,
                                  labelString: 'Time in Video (second)'
                                }
                  }],
                  yAxes: [{
                    stacked: true,
                    scaleLabel: {
                                  display: true,
                                  labelString: 'Count of Expressions in The Frame'
                                }
                  }]
                }
              }
            });
    
        let detailLineCtx = document.getElementById('detail-line').getContext('2d');
        let detailLineData = {
            labels: detailLabels,
            datasets: [
            {
              label: 'Angry',
              data: extracDetailExpression(resultArray, 'ANGRY'),
              backgroundColor: "#E5004F",
              borderColor: "#E5004F",
              borderWidth: 5,
              fill: false
            },
            {
              label: 'Disgust',
              data: extracDetailExpression(resultArray, 'DISGUST'),
              backgroundColor: "#C49958",
              borderColor: "#C49958",
              borderWidth: 5,
              fill: false
            },
            {
              label: 'Fear',
              data: extracDetailExpression(resultArray, 'FEAR'),
              backgroundColor: "#4D4398",
              borderColor: "#4D4398",
              borderWidth: 5,
              fill: false
            },
            {
              label: 'Sad',
              data: extracDetailExpression(resultArray, 'SAD'),
              backgroundColor: "#FFF9B1",
              borderColor: "#FFF9B1",
              borderWidth: 5,
              fill: false
            },
            {
              label: 'Neutral',
              data: extracDetailExpression(resultArray, 'NEUTRAL'),
              backgroundColor: "#FEECD2",
              borderColor: "#FEECD2",
              borderWidth: 5,
              fill: false
            },{
              label: 'Happy',
              data: extracDetailExpression(resultArray, 'HAPPY'),
              backgroundColor: "#F39800",
              borderColor: "#F39800",
              borderWidth: 5,
              fill: false
            },
            {
              label: 'Surprise',
              data: extracDetailExpression(resultArray, 'SURPRISE'),
              backgroundColor: "#F5B090",
              borderColor: "#F5B090",
              borderWidth: 5,
              fill: false
            }]
          };
          let detailLineChart = new Chart(detailLineCtx, {
              type: 'line',
              data: detailLineData,
              options: {
                title: {
                  display: true,
                  text: 'Audience Expression Detailed Timeline'
                },
                tooltips: {
                  mode: 'index',
                  intersect: false
                },
                responsive: true,
                scales: {
                  xAxes: [{
                    scaleLabel: {
                                  display: true,
                                  labelString: 'Time in Video (second)'
                                }
                  }],
                  yAxes: [{
                    scaleLabel: {
                                  display: true,
                                  labelString: 'Count of Expressions in The Frame'
                                }
                  }]
                }
              }
            });
    </script>
  </body>
</html>
