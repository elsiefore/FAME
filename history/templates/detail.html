<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <!-- Custom styles for this template -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/cover.css' %}"></link>

    <title>FAME</title>
  </head>
  <body class="text-center">
    <div class="cover-container d-flex h-100 p-3 mx-auto flex-column">
      <header class="masthead mb-auto">
        <div class="inner">
          <h3 class="masthead-brand">FAME</h3>
          <nav class="nav nav-masthead justify-content-center">
            <a class="nav-link" href="/">Home</a>
            <a class="nav-link" href="/history">History</a>
          </nav>
        </div>
      </header>

      <main role="main" class="inner cover">
        <canvas id="overview" width="800" height="400"></canvas>
        <canvas id="detail" width="800" height="400"></canvas>
      </main>

      <footer class="mastfoot mt-auto">
        <div class="inner">
          <p>
            Facial Analyzer for Multimedia Entertainment
          </p>
        </div>
      </footer>
    </div>
    <p id="result" style="display: none;">{{ result.result }}</p>
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script>
        let resultArray = JSON.parse($("#result").text().replace(/'/g, '"')).result;
        resultArray.sort((a, b) => (a.timestamp > b.timestamp) ? 1 : -1);

        /* Overview Chart*/
        let extractExpressionResult = function(expressions, expressionArray) {
          let total = 0;
          let nonnegative = 0;
          Object.keys(expressions).forEach(key => {
            total += expressions[key];
            if (expressionArray.includes(key)) nonnegative += expressions[key];
          });
          return nonnegative / total * 100;
        };
        let overviewLabels = resultArray.map(x => x.timestamp);
        let overviewDataPos = resultArray.map(x => extractExpressionResult(x.expressions, ['HAPP', 'SURPRISE']));
        let overviewDataNeg = resultArray.map(x => -(100 - extractExpressionResult(x.expressions, ['ANGRY', 'DISGUST', 
        'FEAR', 'SAD'])));
        let overviewDataNeu = resultArray.map(x => extractExpressionResult(x.expressions, ['NEUTRAL']));

        var overviewCtx = document.getElementById('overview').getContext('2d');
        var overviewChart = new Chart(overviewCtx, {
                type: 'line',
                data: {
                    labels: overviewLabels,
                    datasets: [{
                                  label: '% Positive Expressions',
                                  data: overviewDataPos,
                                  backgroundColor: "rgb(255, 99, 132)",
					                        borderColor: "rgb(255, 99, 132)",
                                  borderWidth: 1,
                                  fill: false
                              },
                              {
                                  label: '% Negative Expressions',
                                  data: overviewDataNeg,
                                  backgroundColor: "rgb(54, 162, 235)",
					                        borderColor: "rgb(54, 162, 235)",
                                  borderWidth: 1,
                                  fill: false
                              },
                              {
                                  label: '% Neutral Expressions',
                                  data: overviewDataNeu,
                                  backgroundColor: "rgb(255, 205, 86)",
					                        borderColor: "rgb(255, 205, 86)",
                                  borderWidth: 1,
                                  fill: false
                              }]
                              },
                              options: {
                                  responsive: true,
                                  title: {
                                    display: true,
                                    text: 'Audience Expression Overview Trend'
                                  },
                                  tooltips: {
                                    mode: 'index',
                                    intersect: false,
                                  },
                                  hover: {
                                    mode: 'nearest',
                                    intersect: true
                                  },
                                  scales: {
                                    xAxes: [{
                                      display: true,
                                      scaleLabel: {
                                        display: true,
                                        labelString: 'Time in Video (second)'
                                      }
                                    }],
                                    yAxes: [{
                                      display: true,
                                      scaleLabel: {
                                        display: true,
                                        labelString: 'Percentage %'
                                      }
                                    }]
                                  }
                                }
                          });

        /* Details Chart*/
        let extracDetailExpression = function(resultArray, expression) {
            let expressionArray = [];
            resultArray.forEach(x => {
              if (Object.keys(x.expressions).includes(expression)) {
                expressionArray.push(x.expressions[expression]);
              } else {
                expressionArray.push(0);
              }
            });
            return expressionArray;
        };

        let detailLabels = resultArray.map(x => x.timestamp);
        let detailCtx = document.getElementById('detail').getContext('2d');
        let detailData = {
            labels: detailLabels,
            datasets: [
            {
              label: 'Angry',
              data: extracDetailExpression(resultArray, 'ANGRY'),
              backgroundColor: "#E5004F",
              borderColor: "#E5004F",
              borderWidth: 1,
            },
            {
              label: 'Disgust',
              data: extracDetailExpression(resultArray, 'DISGUST'),
              backgroundColor: "#C49958",
              borderColor: "#C49958",
              borderWidth: 1,
            },
            {
              label: 'Fear',
              data: extracDetailExpression(resultArray, 'FEAR'),
              backgroundColor: "#4D4398",
              borderColor: "#4D4398",
              borderWidth: 1,
            },
            {
              label: 'Sad',
              data: extracDetailExpression(resultArray, 'SAD'),
              backgroundColor: "#FFF9B1",
              borderColor: "#FFF9B1",
              borderWidth: 1,
            },
            {
              label: 'Neutral',
              data: extracDetailExpression(resultArray, 'NEUTRAL'),
              backgroundColor: "#FEECD2",
              borderColor: "#FEECD2",
              borderWidth: 1,
            },{
              label: 'Happy',
              data: extracDetailExpression(resultArray, 'HAPPY'),
              backgroundColor: "#F39800",
              borderColor: "#F39800",
              borderWidth: 1,
            },
            {
              label: 'Surprise',
              data: extracDetailExpression(resultArray, 'SURPRISE'),
              backgroundColor: "#F5B090",
              borderColor: "#F5B090",
              borderWidth: 1,
            }]
          };
          
        let detailChart = new Chart(detailCtx, {
              type: 'bar',
              data: detailData,
              options: {
                title: {
                  display: true,
                  text: 'Audience Expression Detailed Timeline'
                },
                tooltips: {
                  mode: 'index',
                  intersect: false
                },
                responsive: true,
                scales: {
                  xAxes: [{
                    stacked: true,
                    scaleLabel: {
                                  display: true,
                                  labelString: 'Time in Video (second)'
                                }
                  }],
                  yAxes: [{
                    stacked: true,
                    scaleLabel: {
                                  display: true,
                                  labelString: 'Count of Expressions in The Frame'
                                }
                  }]
                }
              }
            });
    </script>
  </body>
</html>
